# reserva-request-lambda

## 概要

一連のプログラムは、Reserva サイトと、RemoteLock API を相互に制御するものです。Reserva サイトと RemoteLock には連携する機能が存在していますが、高価であり、機能も限定的です。この実装は、都度予約の事前登録有無による自動承認、定期的な自動予約、定期的なレポーティング、メールアドレスベースでの名寄せなどを原則無料で実現します。

## 各機能の説明

各機能の流れについて以下述べます。

### 都度予約の自動承認と鍵番号の振り出し

都度予約がされた場合にすべきことは、予約の承認/拒否の判断と鍵番号の振り出しです。

Reserva によって都度予約されたエントリーの身元確認は、Reserva の予約サイトの入力項目が不足していることや、同一メールアドレスで複数の名前を都度使うことができるなどの理由で単独ではできません。そこで、別途事前登録されたデータと照合して身元を確認し、確認できたエントリのみ承認するようにします。予約された際には、メールで Reserva から通知が届きます。本実装では、GAS を用いて GMail に届くメールを 5分に一度チェックし、Reserva から届いたスター付きのメールがあれば、その情報を基に AWS 側の Lambda URL を呼び出します。

Lambda 側は、予約申請時に Reserva から送付される URL にアクセスして得られたメールアドレスを Google Spreadsheet 上の事前登録マスタと照合し、当該メールアドレスが事前登録されたものであれば承諾し、その他は拒否します。承諾された予約については、当該時間帯n分前からのみアクセス可能なアクセスゲストが RemoteLock API にて生成され、鍵番号が予約ユーザに通知されるよう、RemoteLock の通知メールをセットします。

### 予約のキャンセル

予約がキャンセルされた際には、該当する RemoteLock のアクセスゲストも削除する必要があります。

予約キャンセル時に届くメールを基に、GAS にてキャンセルのための Lambda URL 呼び出しがなされます。Reserva から送付される URL から予約者のメールアドレスを得て、それを基に該当する RemoteLock のアクセスゲストを検索し、削除します。

### 定期的な予約の作成

特定の予約者について、定期的に決められた日時での予約をすることが確定している場合に自動的に当該の予約を作成することで利便性を高めます。RemoteLock のアクセスユーザーに対して特定のフォーマットで日時を指定し、それに合わせてアクセス不可の時間帯を設定し、Reserva の予約をセットすることで実現します。

# GAS

以下のサイトを参考にしています。

https://www.lisz-works.com/entry/gas-recv-gmail-check

https://valmore.work/how-to-copy-gmail-message-to-spreadsheet/

https://developers.google.com/apps-script/reference/url-fetch/url-fetch-app#fetch(String,Object)

https://journal.lampetty.net/entry/call-external-api-in-gas

スターにする条件は別途 GMail の機能にて設定されています。

# テスト方法

```bash
$ . ./env
$ pytest
```

# デプロイ方法

```bash
$ sam build
$ sam deploy --profile <yourprofile>
```

## Use the SAM CLI to build and test locally

Build your application with the `sam build --use-container` command.

```bash
reserva-request-lambda$ sam build --use-container
```

The SAM CLI installs dependencies defined in `hello_world/requirements.txt`, creates a deployment package, and saves it in the `.aws-sam/build` folder.

Test a single function by invoking it directly with a test event. An event is a JSON document that represents the input that the function receives from the event source. Test events are included in the `events` folder in this project.

Run functions locally and invoke them with the `sam local invoke` command.

```bash
reserva-request-lambda$ sam local invoke ReservaRequestFunction --event test1-event.json --profile private
```

The SAM CLI can also emulate your application's API. Use the `sam local start-api` to run the API locally on port 3000.

```bash
reserva-request-lambda$ sam local start-api
reserva-request-lambda$ curl http://localhost:3000/
```

The SAM CLI reads the application template to determine the API's routes and the functions that they invoke. The `Events` property on each function's definition includes the route and method for each path.

```yaml
      Events:
        HelloWorld:
          Type: Api
          Properties:
            Path: /hello
            Method: get
```

## Add a resource to your application


## Fetch, tail, and filter Lambda function logs

To simplify troubleshooting, SAM CLI has a command called `sam logs`. `sam logs` lets you fetch logs generated by your deployed Lambda function from the command line. In addition to printing the logs on the terminal, this command has several nifty features to help you quickly find the bug.

`NOTE`: This command works for all AWS Lambda functions; not just the ones you deploy using SAM.

```bash
reserva-request-lambda$ sam logs -n HelloWorldFunction --stack-name reserva-request-lambda --tail
```

You can find more information and examples about filtering Lambda function logs in the [SAM CLI Documentation](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-logging.html).

## Tests

Tests are defined in the `tests` folder in this project. Use PIP to install the test dependencies and run tests.

```bash
reserva-request-lambda$ pip install -r tests/requirements.txt --user
# unit test
reserva-request-lambda$ python -m pytest tests/unit -v
# integration test, requiring deploying the stack first.
# Create the env variable AWS_SAM_STACK_NAME with the name of the stack we are testing
reserva-request-lambda$ AWS_SAM_STACK_NAME=<stack-name> python -m pytest tests/integration -v
```

## Cleanup

To delete the sample application that you created, use the AWS CLI. Assuming you used your project name for the stack name, you can run the following:

```bash
aws cloudformation delete-stack --stack-name reserva-request-lambda
```

## Resources

See the [AWS SAM developer guide](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html) for an introduction to SAM specification, the SAM CLI, and serverless application concepts.

Next, you can use AWS Serverless Application Repository to deploy ready to use Apps that go beyond hello world samples and learn how authors developed their applications: [AWS Serverless Application Repository main page](https://aws.amazon.com/serverless/serverlessrepo/)
